<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Projekt Opiekun - Naprawiona Fizyka</title>
    <style>
        body { margin: 0; background: #050505; color: #ccc; font-family: monospace; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #gameContainer { position: relative; box-shadow: 0 0 30px #000; }
        canvas { background: #111; display: block; border: 2px solid #333; }
        #ui-layer { position: absolute; top: 10px; left: 10px; pointer-events: none; }
        .heart { font-size: 24px; color: #e74c3c; font-weight: bold; }
        #inventory-display { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid #444; font-size: 13px; }
        #message-box { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); background: black; color: white; padding: 10px; border: 1px solid white; display: none; z-index: 100; }
    </style>
</head>
<body>

<div id="gameContainer">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="ui-layer">
        <div id="heart-display" class="heart">♥ HP: 100%</div>
    </div>
    <div id="inventory-display">
        <div style="color: yellow">RĘKA: <span id="hand-slot">Pusta</span></div>
        <div style="color: cyan">UBIÓR: <span id="clothing-slot">Brak</span></div>
    </div>
    <div id="message-box"></div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// --- KONFIGURACJA ---
const SPEED_MOD = 0.6; 
const GRAVITY = 0.5 * SPEED_MOD;
const PLAYER_SPEED = 4 * SPEED_MOD;
const JUMP_FORCE = -9 * SPEED_MOD;

// --- GRAFIKI (System Fallback) ---
const textures = {};
const imgNames = ['player', 'tarantula', 'item_noz', 'item_zapalniczka', 'bg_hol', 'bg_sklad'];
imgNames.forEach(name => {
    const img = new Image();
    img.src = `img/${name}.png`;
    textures[name] = img;
});

function drawSprite(name, x, y, w, h, color) {
    const img = textures[name];
    if (img && img.complete && img.naturalWidth !== 0) {
        ctx.drawImage(img, x, y, w, h);
    } else {
        ctx.fillStyle = color;
        ctx.fillRect(x, y, w, h);
    }
}

// --- OBIEKTY GRY ---
let game = {
    room: "hol",
    messageTimer: 0,
    projectiles: []
};

let player = {
    x: 100, y: 400,
    width: 30, height: 60,
    vx: 0, vy: 0,
    hp: 100,
    facingRight: true,
    handItem: null,
    clothing: []
};

let tarantula = {
    active: true,
    room: "sklad",
    x: 600, y: 510, // Nieco wyżej, żeby nóż trafił
    w: 60, h: 40,
    stunned: 0,
    speed: 1.5 * SPEED_MOD
};

const rooms = {
    "hol": {
        bg: "bg_hol",
        platforms: [[0, 550, 800, 50]],
        doors: [{ to: "sklad", x: 700, y: 450, w: 50, h: 100, tx: 100, ty: 450 }],
        items: [
            { id: "noz", name: "Nóż", x: 200, y: 520, color: "silver" },
            { id: "zapalniczka", name: "Zapalniczka", x: 300, y: 520, color: "orange" }
        ]
    },
    "sklad": {
        bg: "bg_sklad",
        platforms: [[0, 550, 800, 50]],
        doors: [{ to: "hol", x: 50, y: 450, w: 50, h: 100, tx: 650, ty: 450 }],
        items: []
    }
};

// --- STEROWANIE ---
const keys = {};
window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

window.addEventListener('keydown', (e) => {
    if (e.key.toLowerCase() === 'e') interact();
    if (e.key.toLowerCase() === 'g') throwKnife();
    if (e.key.toLowerCase() === 'f') useLighter();
});

function showMessage(txt) {
    const b = document.getElementById('message-box');
    b.innerText = txt; b.style.display = 'block';
    game.messageTimer = 120;
}

// --- LOGIKA ---
function throwKnife() {
    if (player.handItem && player.handItem.id === 'noz') {
        game.projectiles.push({
            x: player.x, y: player.y + 20,
            vx: player.facingRight ? 10 : -10,
            w: 15, h: 5
        });
        player.handItem = null;
        showMessage("Rzucono nożem!");
    }
}

function useLighter() {
    if (player.handItem && player.handItem.id === 'zapalniczka' && game.room === "sklad" && tarantula.active) {
        let dist = Math.abs(player.x - tarantula.x);
        if (dist < 60) {
            tarantula.active = false;
            player.handItem = null;
            showMessage("Tarantula spłonęła!");
        }
    }
}

function interact() {
    const r = rooms[game.room];
    r.items.forEach((it, i) => {
        if (Math.abs(player.x - it.x) < 40) {
            if (player.handItem) r.items.push(player.handItem);
            player.handItem = it;
            r.items.splice(i, 1);
            showMessage("Podniesiono: " + it.name);
        }
    });
}

function update() {
    // Wysokość zależna od kucania (S)
    let targetHeight = 60;
    if (keys['s']) targetHeight = 35;
    
    // NAPRAWA WPADANIA: Jeśli zmieniamy wysokość, korygujemy Y, by stopy były w tym samym miejscu
    if (player.height !== targetHeight) {
        player.y += (player.height - targetHeight);
        player.height = targetHeight;
    }

    // Ruch
    if (keys['a']) { player.vx = -PLAYER_SPEED; player.facingRight = false; }
    else if (keys['d']) { player.vx = PLAYER_SPEED; player.facingRight = true; }
    else { player.vx = 0; }

    player.vy += GRAVITY;
    player.x += player.vx;
    player.y += player.vy;

    // Kolizja z podłogą
    rooms[game.room].platforms.forEach(p => {
        if (player.x + player.width > p[0] && player.x < p[0] + p[2] &&
            player.y + player.height > p[1] && player.y + player.height < p[1] + 15) {
            player.y = p[1] - player.height;
            player.vy = 0;
            if (keys['w'] && player.height === 60) player.vy = JUMP_FORCE;
        }
    });

    // Drzwi
    rooms[game.room].doors.forEach(d => {
        if (keys['f'] && Math.abs(player.x - d.x) < 30) {
            game.room = d.to;
            player.x = d.tx;
            player.y = d.ty;
        }
    });

    // Projektyle i Tarantula
    game.projectiles.forEach((p, pi) => {
        p.x += p.vx;
        if (game.room === "sklad" && tarantula.active) {
            if (p.x < tarantula.x + tarantula.w && p.x + p.w > tarantula.x &&
                p.y < tarantula.y + tarantula.h && p.y + p.h > tarantula.y) {
                tarantula.stunned = 180;
                game.projectiles.splice(pi, 1);
                showMessage("Tarantula ogłuszona!");
            }
        }
    });

    if (game.room === "sklad" && tarantula.active) {
        if (tarantula.stunned > 0) {
            tarantula.stunned--;
        } else {
            if (player.x > tarantula.x) tarantula.x += tarantula.speed;
            else tarantula.x -= tarantula.speed;
            
            if (Math.abs(player.x - tarantula.x) < 30 && Math.abs(player.y - tarantula.y) < 40) {
                player.hp -= 0.5;
            }
        }
    }

    if (game.messageTimer > 0) {
        game.messageTimer--;
        if (game.messageTimer === 0) document.getElementById('message-box').style.display = 'none';
    }

    updateUI();
}

function updateUI() {
    document.getElementById('heart-display').innerText = `♥ HP: ${Math.ceil(player.hp)}%`;
    document.getElementById('hand-slot').innerText = player.handItem ? player.handItem.name : "Pusta";
}

function draw() {
    ctx.clearRect(0, 0, 800, 600);
    const r = rooms[game.room];
    
    // Tło
    drawSprite(r.bg, 0, 0, 800, 600, "#222");

    // Platformy
    ctx.fillStyle = "#333";
    r.platforms.forEach(p => ctx.fillRect(p[0], p[1], p[2], p[3]));

    // Drzwi
    ctx.fillStyle = "brown";
    r.doors.forEach(d => ctx.fillRect(d.x, d.y, d.w, d.h));

    // Przedmioty
    r.items.forEach(it => drawSprite(`item_${it.id}`, it.x, it.y, 30, 30, it.color));

    // Tarantula
    if (game.room === "sklad" && tarantula.active) {
        if (tarantula.stunned > 0 && Math.floor(Date.now()/100)%2 === 0) ctx.globalAlpha = 0.5;
        drawSprite('tarantula', tarantula.x, tarantula.y, tarantula.w, tarantula.h, "purple");
        ctx.globalAlpha = 1.0;
    }

    // Nóż w locie
    ctx.fillStyle = "white";
    game.projectiles.forEach(p => ctx.fillRect(p.x, p.y, p.w, p.h));

    // Gracz
    drawSprite('player', player.x, player.y, player.width, player.height, "blue");
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
