<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Projekt Opiekun - Wersja Graficzna</title>
    <style>
        body {
            margin: 0;
            background-color: #050505;
            color: #ccc;
            font-family: 'Courier New', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        #gameContainer {
            position: relative;
            box-shadow: 0 0 30px #000;
        }

        canvas {
            background-color: #111;
            display: block;
        }

        /* UI */
        #ui-layer {
            position: absolute;
            top: 10px;
            left: 10px;
            pointer-events: none;
            text-shadow: 1px 1px 2px black;
        }

        .heart { font-size: 30px; color: #e74c3c; }
        
        .keys-container { display: flex; gap: 5px; margin-top: 5px; }
        .key-slot { width: 25px; height: 25px; border: 2px solid #555; background: rgba(0,0,0,0.5); }
        .key-found { background: #bdc3c7; border-color: #c0392b; }

        #inventory-display {
            position: absolute;
            top: 10px;
            right: 10px;
            text-align: right;
            font-size: 14px;
            background: rgba(0,0,0,0.6);
            padding: 10px;
            border-radius: 5px;
        }

        #message-box {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border: 1px solid #fff;
            display: none;
            text-align: center;
            font-size: 18px;
            max-width: 80%;
        }
    </style>
</head>
<body>

<div id="gameContainer">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    
    <div id="ui-layer">
        <div id="heart-display" class="heart">♥ 100%</div>
        <div class="keys-container">
            <div id="key1" class="key-slot"></div>
            <div id="key2" class="key-slot"></div>
            <div id="key3" class="key-slot"></div>
        </div>
    </div>

    <div id="inventory-display">
        <div style="color: yellow; margin-bottom: 5px;">RĘKA [E - Wyrzuć]:</div>
        <div id="hand-slot" style="font-weight: bold; font-size: 16px;">Pusta</div>
        <hr style="border-color: #444;">
        <div style="color: cyan; margin-bottom: 5px;">UBIÓR (Pasywne):</div>
        <div id="clothing-slot">Brak</div>
    </div>

    <div id="message-box"></div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

/**
 * ZARZĄDZANIE GRAFIKĄ
 * System ładuje obrazki z folderu img/. Jeśli plik nie istnieje, rysuje kolorowy kwadrat.
 */
const textures = {};
const imageList = [
    'player', 'tarantula', 'breather',
    'bg_hol', 'bg_salon', 'bg_kuchnia', 'bg_sypialnia', 'bg_korytarz', 
    'bg_strych', 'bg_poddasze', 'bg_sklad', 'bg_kotlownia', 'bg_bunkier',
    'item_buty', 'item_klucz', 'item_noz', 'item_zapalniczka', 'item_dyktafon',
    'item_maska', 'item_klucz_nastawny', 'item_lampa', 'item_lom', 'item_wegiel',
    'item_rekawice', 'item_bomba', 'item_skrzynia', 'item_stol', 'item_piec',
    'item_part1', 'item_part2', 'item_part3'
];

imageList.forEach(name => {
    const img = new Image();
    // Zakładamy, że obrazki są w folderze img/ i mają rozszerzenie png (przedmioty) lub jpg (tła)
    let ext = name.startsWith('bg_') ? '.jpg' : '.png';
    img.src = 'img/' + name + ext; 
    textures[name] = img;
});

// Funkcja rysująca sprite'a lub zastępczy prostokąt
function drawSprite(name, x, y, w, h, fallbackColor) {
    const img = textures[name];
    if (img && img.complete && img.naturalHeight !== 0) {
        ctx.drawImage(img, x, y, w, h);
    } else {
        ctx.fillStyle = fallbackColor || 'magenta';
        ctx.fillRect(x, y, w, h);
        // Opcjonalnie napisz co to jest, jeśli brak grafiki
        if(w > 30) {
            ctx.fillStyle = "white";
            ctx.font = "10px Arial";
            ctx.fillText(name.substring(0,5), x, y+10);
        }
    }
}

/**
 * KONFIGURACJA GRY
 * Prędkość zmniejszona o 40% (mnożnik 0.6)
 */
const SPEED_MODIFIER = 0.6; 
const GRAVITY = 0.5 * SPEED_MODIFIER;
const PLAYER_SPEED = 4 * SPEED_MODIFIER; 
const JUMP_FORCE = -9 * SPEED_MODIFIER; // Skok musi być proporcjonalny do grawitacji

let game = {
    currentRoom: "hol",
    gameOver: false,
    messageTimer: 0,
    flags: {
        stoveOff: false,
        bunkierOpen: false,
        finalKeyForged: false,
        recorderData: null,
        isBasementLocked: true 
    }
};

let player = {
    x: 100, y: 500, width: 30, height: 60,
    vx: 0, vy: 0,
    hp: 100,
    state: "standing",
    facingRight: true,
    
    // NOWY SYSTEM EKWIPUNKU
    handItem: null, // Obiekt lub null. Tylko 1 przedmiot w ręce.
    clothing: [],   // Tablica nazw ubrań (Buty, Maska, Rękawice)
    keysParts: [false, false, false]
};

let monsters = {
    tarantula: { active: true, room: "sklad", x: 400, y: 500, w: 60, h: 40, hp: 2 },
    breather: { active: true, room: "bunkier", x: 600, y: 460, w: 50, h: 90, hp: 100, speed: 2.0 * SPEED_MODIFIER }
};

/**
 * DEFINICJA POKOI
 */
const rooms = {
    "hol": {
        name: "Hol", bgCode: "bg_hol",
        platforms: [[0, 550, 800, 50]],
        doors: [
            { to: "salon", x: 10, y: 450, w: 40, h: 100, tx: 700, ty: 450 },
            { to: "kuchnia", x: 750, y: 450, w: 40, h: 100, tx: 50, ty: 450 },
            { to: "korytarz", x: 380, y: 450, w: 40, h: 100, tx: 380, ty: 450, type: "stairs_up" }, // Schody to teraz drzwi
            { to: "sklad", x: 200, y: 450, w: 40, h: 100, tx: 50, ty: 450, locked: true, keyName: "Klucz Piwniczny" }
        ],
        items: [
            { id: "buty", name: "Buty", type: "clothing", x: 300, y: 520, tex: "item_buty", color: "brown" },
            { id: "stół_miejsce", name: "Miejsce na Stół", type: "static", x: 500, y: 520, tex: "", color: "grey" }
        ]
    },
    "salon": {
        name: "Salon", bgCode: "bg_salon",
        platforms: [[0, 550, 800, 50]],
        doors: [ { to: "hol", x: 750, y: 450, w: 40, h: 100, tx: 50, ty: 450 } ],
        items: [
            { id: "klucz_piwnica", name: "Klucz Piwniczny", type: "hand", x: 200, y: 520, tex: "item_klucz", color: "gold" },
            { id: "regal", name: "Regał", type: "static", x: 400, y: 450, w: 60, h: 100, tex: "", color: "sienna" },
            { id: "klucz_czesc_3", name: "Część Klucza 3", type: "keypart", partIdx: 2, x: 420, y: 520, tex: "item_part3", color: "silver", hidden: true }
        ]
    },
    "kuchnia": {
        name: "Kuchnia", bgCode: "bg_kuchnia",
        platforms: [[0, 550, 800, 50]],
        doors: [ { to: "hol", x: 10, y: 450, w: 40, h: 100, tx: 700, ty: 450 } ],
        items: [
            { id: "noz", name: "Nóż", type: "hand", x: 300, y: 520, tex: "item_noz", color: "silver" },
            { id: "zapalniczka", name: "Zapalniczka", type: "hand", x: 350, y: 520, tex: "item_zapalniczka", color: "orange" },
            { id: "zsyp", name: "Zsyp", type: "static", x: 600, y: 530, w: 100, h: 20, tex: "", color: "black" }
        ]
    },
    "korytarz": {
        name: "Korytarz", bgCode: "bg_korytarz",
        platforms: [[0, 550, 800, 50]],
        doors: [
            { to: "hol", x: 380, y: 450, w: 40, h: 100, tx: 380, ty: 450, type: "stairs_down" },
            { to: "sypialnia", x: 10, y: 450, w: 40, h: 100, tx: 700, ty: 450 },
            { to: "strych", x: 600, y: 450, w: 40, h: 100, tx: 50, ty: 450, locked: true, keyName: "Klucz Piwniczny" }
        ],
        items: []
    },
    "sypialnia": {
        name: "Sypialnia", bgCode: "bg_sypialnia",
        platforms: [[0, 550, 800, 50]],
        doors: [ { to: "korytarz", x: 750, y: 450, w: 40, h: 100, tx: 40, ty: 450 } ],
        items: [ { id: "dyktafon", name: "Dyktafon", type: "hand", x: 400, y: 520, tex: "item_dyktafon", color: "cyan" } ]
    },
    "strych": {
        name: "Strych", bgCode: "bg_strych",
        platforms: [[0, 550, 800, 50]],
        doors: [
            { to: "korytarz", x: 10, y: 450, w: 40, h: 100, tx: 550, ty: 450 },
            { to: "poddasze", x: 400, y: 450, w: 60, h: 100, tx: 400, ty: 500, locked: true, keyName: "Łom" } // Drabina
        ],
        items: [
            { id: "maska", name: "Maska Gazowa", type: "clothing", x: 200, y: 520, tex: "item_maska", color: "green" },
            { id: "klucz_nastawny", name: "Klucz Nastawny", type: "hand", x: 500, y: 520, tex: "item_klucz_nastawny", color: "grey" },
            { id: "lampa", name: "Lampa Węglowa", type: "hand", x: 600, y: 520, tex: "item_lampa", color: "yellow" }
        ]
    },
    "poddasze": {
        name: "Poddasze", bgCode: "bg_poddasze",
        lowCeiling: true, hazard: "wata",
        platforms: [[0, 550, 800, 50]],
        doors: [ { to: "strych", x: 400, y: 500, w: 60, h: 50, tx: 400, ty: 450 } ], // Klapa w dół
        items: [
            { id: "klucz_czesc_1", name: "Część Klucza 1", type: "keypart", partIdx: 0, x: 700, y: 520, tex: "item_part1", color: "silver" },
            { id: "pakiet_wwi", name: "Broń WWI", type: "hand", x: 100, y: 520, tex: "item_skrzynia", color: "olive" }
        ]
    },
    "sklad": {
        name: "Skład", bgCode: "bg_sklad",
        platforms: [[0, 550, 800, 50]],
        doors: [
            { to: "hol", x: 10, y: 450, w: 40, h: 100, tx: 200, ty: 450 },
            { to: "kotlownia", x: 750, y: 450, w: 40, h: 100, tx: 50, ty: 450 }
        ],
        items: [
            { id: "lom", name: "Łom", type: "hand", x: 200, y: 520, tex: "item_lom", color: "red" },
            { id: "wegiel", name: "Węgiel", type: "hand", x: 300, y: 520, tex: "item_wegiel", color: "black" },
            { id: "rekawice", name: "Rękawice", type: "clothing", x: 400, y: 520, tex: "item_rekawice", color: "orange" },
            { id: "bomba", name: "Bomba", type: "hand", x: 500, y: 520, tex: "item_bomba", color: "white" }
        ]
    },
    "kotlownia": {
        name: "Kotłownia", bgCode: "bg_kotlownia",
        hazard: "czad",
        platforms: [[0, 550, 800, 50]],
        doors: [
            { to: "sklad", x: 10, y: 450, w: 40, h: 100, tx: 700, ty: 450 },
            { to: "bunkier", x: 400, y: 450, w: 50, h: 50, tx: 50, ty: 450, locked: true, keyName: "tunel" }
        ],
        items: [
            { id: "skrzynia", name: "Skrzynia", type: "hand", x: 150, y: 520, tex: "item_skrzynia", color: "brown" },
            { id: "stol", name: "Stół Majsterkowicza", type: "hand", x: 600, y: 500, w: 60, h: 50, tex: "item_stol", color: "blue", heavy: true }, 
            { id: "piec", name: "Piec", type: "static", x: 300, y: 450, w: 80, h: 100, tex: "item_piec", color: "darkred" }
        ]
    },
    "bunkier": {
        name: "Bunkier", bgCode: "bg_bunkier",
        dark: true,
        platforms: [[0, 550, 800, 50]],
        doors: [ { to: "kotlownia", x: 10, y: 450, w: 40, h: 100, tx: 400, ty: 450 } ],
        items: [
            { id: "klucz_czesc_2", name: "Część Klucza 2", type: "keypart", partIdx: 1, x: 700, y: 520, tex: "item_part2", color: "silver" }
        ]
    }
};

/**
 * OBSŁUGA WEJŚCIA
 */
const keys = { w:false, a:false, s:false, d:false, z:false };

window.addEventListener('keydown', (e) => {
    let k = e.key.toLowerCase();
    if(k === 'w') keys.w = true;
    if(k === 'a') keys.a = true;
    if(k === 's') keys.s = true;
    if(k === 'd') keys.d = true;
    if(k === 'z') keys.z = true;
    if(k === 'e') actionInteract();
    if(k === 'f') actionDoor();
});
window.addEventListener('keyup', (e) => {
    let k = e.key.toLowerCase();
    if(k === 'w') keys.w = false;
    if(k === 'a') keys.a = false;
    if(k === 's') keys.s = false;
    if(k === 'd') keys.d = false;
    if(k === 'z') keys.z = false;
});

function showMessage(msg) {
    const box = document.getElementById('message-box');
    box.innerText = msg;
    box.style.display = 'block';
    game.messageTimer = 180;
}

/**
 * LOGIKA GRY
 */
function update() {
    if(game.gameOver) return;
    if(game.messageTimer > 0) {
        game.messageTimer--;
        if(game.messageTimer <= 0) document.getElementById('message-box').style.display = 'none';
    }

    // 1. RUCH I FIZYKA
    let currentSpeed = PLAYER_SPEED;
    if(keys.z) {
        player.state = "crawling";
        player.height = 25;
        currentSpeed *= 0.3;
    } else if(keys.s) {
        player.state = "crouching";
        player.height = 40;
    } else {
        player.state = "standing";
        player.height = 60;
        if(rooms[game.currentRoom].lowCeiling) {
             player.state = "crawling"; 
             player.height = 25;
             currentSpeed *= 0.3;
        }
    }

    if(keys.a) { player.vx = -currentSpeed; player.facingRight = false; }
    else if(keys.d) { player.vx = currentSpeed; player.facingRight = true; }
    else player.vx = 0;

    player.vy += GRAVITY;
    player.x += player.vx;
    player.y += player.vy;

    // Kolizja z podłogą
    let room = rooms[game.currentRoom];
    let onGround = false;
    room.platforms.forEach(p => {
        if(player.x + player.width > p[0] && player.x < p[0] + p[2] &&
           player.y + player.height > p[1] && player.y + player.height < p[1] + 20) {
               player.y = p[1] - player.height;
               player.vy = 0;
               onGround = true;
        }
    });
    // Ograniczenia ekranu
    if(player.x < 0) player.x = 0;
    if(player.x > 800 - player.width) player.x = 800 - player.width;

    if(onGround && keys.w && player.state === "standing") {
        player.vy = JUMP_FORCE;
    }

    // 2. ŚRODOWISKO (Czad itp.)
    if(room.hazard === "czad" && !player.clothing.includes("Maska Gazowa")) {
        player.hp -= 0.2;
        if(Math.random() < 0.05) showMessage("Duszę się! Potrzebuję maski!");
    }
    if(player.hp <= 0) {
        alert("Śmierć. Odrodzenie...");
        resetGame();
    }

    updateUI();
}

/**
 * INTERAKCJE (KLUCZ E i F)
 */

// Wejście w drzwi (F)
function actionDoor() {
    let room = rooms[game.currentRoom];
    let usedDoor = null;

    room.doors.forEach(door => {
        if(checkOverlap(player, {x: door.x, y: door.y, width: door.w, height: door.h})) {
            usedDoor = door;
        }
    });

    if(usedDoor) {
        if(usedDoor.locked) {
            // Sprawdź czy mamy klucz w RĘCE
            if(player.handItem && player.handItem.name === usedDoor.keyName) {
                showMessage("Otwierasz drzwi używając: " + usedDoor.keyName);
                usedDoor.locked = false; // Odblokowane na stałe w tej sesji
                game.currentRoom = usedDoor.to;
                player.x = usedDoor.tx;
                player.y = usedDoor.ty;
            } else if (usedDoor.keyName === "tunel" && game.flags.bunkierOpen) {
                 game.currentRoom = usedDoor.to;
                 player.x = usedDoor.tx;
                 player.y = usedDoor.ty;
            } else {
                showMessage("Zamknięte. Wymaga: " + usedDoor.keyName);
            }
        } else {
            game.currentRoom = usedDoor.to;
            player.x = usedDoor.tx;
            player.y = usedDoor.ty;
        }
    }
}

// Podnoszenie / Upuszczanie (E)
function actionInteract() {
    let room = rooms[game.currentRoom];
    let foundItemIndex = -1;

    // Sprawdź czy stoimy na przedmiocie
    for(let i=0; i<room.items.length; i++) {
        let it = room.items[i];
        if(!it.hidden && checkOverlap(player, {x: it.x, y: it.y, width: 30, height: 30})) {
            foundItemIndex = i;
            break;
        }
    }

    // 1. Jeśli stoimy na przedmiocie
    if(foundItemIndex !== -1) {
        let newItem = room.items[foundItemIndex];
        
        if(newItem.type === "static") {
            // Obsługa regału itp.
            if(newItem.id === "regal") {
                if(player.clothing.includes("Rękawice")) {
                    newItem.x = 600; 
                    let key = room.items.find(x => x.id === "klucz_czesc_3");
                    if(key) key.hidden = false;
                    showMessage("Przesunięto regał.");
                } else showMessage("Za ciężkie. Potrzeba rękawic.");
            }
            return;
        }

        if(newItem.type === "keypart") {
            player.keysParts[newItem.partIdx] = true;
            room.items.splice(foundItemIndex, 1);
            showMessage("Znaleziono część klucza!");
            return;
        }

        if(newItem.type === "clothing") {
            // Ubrania bierzemy zawsze
            if(!player.clothing.includes(newItem.name)) {
                player.clothing.push(newItem.name);
                room.items.splice(foundItemIndex, 1);
                showMessage("Założono: " + newItem.name);
            }
            return;
        }

        if(newItem.type === "hand") {
            // Jeśli mamy już coś w ręce -> Wymiana
            if(player.handItem) {
                // Stary przedmiot ląduje na ziemi
                let oldItem = player.handItem;
                oldItem.x = player.x;
                oldItem.y = player.y + 20;
                room.items.push(oldItem);
                
                // Nowy do ręki
                player.handItem = newItem;
                room.items.splice(foundItemIndex, 1);
                showMessage("Wymieniono na: " + newItem.name);
            } else {
                // Mamy pustą rękę -> Bierzemy
                player.handItem = newItem;
                room.items.splice(foundItemIndex, 1);
                showMessage("Wzięto: " + newItem.name);
            }
            return;
        }
    } 
    // 2. Jeśli NIE stoimy na przedmiocie, ale mamy coś w ręce -> Wyrzucamy
    else if (player.handItem) {
        let itemToDrop = player.handItem;
        itemToDrop.x = player.x;
        itemToDrop.y = player.y + 20; // Upuść pod nogi
        room.items.push(itemToDrop);
        player.handItem = null;
        showMessage("Wyrzucono: " + itemToDrop.name);
    }
}

function checkOverlap(rect1, rect2) {
    return (rect1.x < rect2.x + rect2.width &&
            rect1.x + rect1.width > rect2.x &&
            rect1.y < rect2.y + rect2.height &&
            rect1.y + rect1.height > rect2.y);
}

function resetGame() {
    player.hp = 100;
    player.x = 100; 
    player.y = 500;
    player.handItem = null;
    player.clothing = [];
    player.keysParts = [false, false, false];
    game.currentRoom = "hol";
}

/**
 * RYSOWANIE
 */
function draw() {
    let room = rooms[game.currentRoom];
    
    // 1. TŁO
    drawSprite(room.bgCode, 0, 0, 800, 600, '#222');

    // 2. PLATFORMY (Podgląd debugowy, w finalnej wersji można usunąć jeśli tło ma podłogę)
    ctx.fillStyle = "rgba(0,0,0,0.5)";
    room.platforms.forEach(p => ctx.fillRect(p[0], p[1], p[2], p[3]));

    // 3. DRZWI
    room.doors.forEach(d => {
        // Drzwi są teraz "duchami", nie rysujemy ścian, chyba że debug
        // Rysujemy podświetlenie, jeśli gracz jest blisko
        if(checkOverlap(player, {x:d.x, y:d.y, width:d.w, height:d.h})) {
            ctx.fillStyle = "rgba(255, 255, 255, 0.2)";
            ctx.fillRect(d.x, d.y, d.w, d.h);
            
            ctx.fillStyle = "white";
            ctx.font = "14px monospace";
            ctx.fillText("[F] Wejdź", player.x - 10, player.y - 10);
            
            if(d.locked) {
                ctx.fillStyle = "red";
                ctx.fillText("(Zamknięte)", player.x - 10, player.y - 25);
            }
        }
    });

    // 4. PRZEDMIOTY
    room.items.forEach(item => {
        if(item.hidden) return;
        let w = item.w || 30;
        let h = item.h || 30;
        drawSprite(item.tex, item.x, item.y, w, h, item.color);

        // Wyświetl nazwę jeśli gracz jest blisko
        if(checkOverlap(player, {x:item.x - 20, y:item.y - 20, width: w+40, height: h+40})) {
            ctx.fillStyle = "lime";
            ctx.font = "12px monospace";
            let action = item.type === "static" ? "[F] Użyj" : "[E] Weź";
            ctx.fillText(item.name, item.x, item.y - 5);
            ctx.fillText(action, item.x, item.y - 18);
        }
    });

    // 5. GRACZ
    drawSprite("player", player.x, player.y, player.width, player.height, "blue");

    // 6. POTWORY
    if(monsters.tarantula.active && game.currentRoom === "sklad") {
        let t = monsters.tarantula;
        drawSprite("tarantula", t.x, t.y, t.w, t.h, "purple");
    }

    // 7. CIEMNOŚĆ
    if(room.dark && !player.handItem?.name?.includes("Lampa")) {
        ctx.fillStyle = "black";
        ctx.fillRect(0,0,800,600);
    }
}

function updateUI() {
    document.getElementById('heart-display').innerText = "♥ " + Math.floor(player.hp) + "%";
    
    // Klucze
    for(let i=0; i<3; i++) {
        let slot = document.getElementById('key'+(i+1));
        if(player.keysParts[i]) slot.classList.add('key-found');
        else slot.classList.remove('key-found');
    }

    // Ekwipunek
    let handText = player.handItem ? player.handItem.name : "Pusta";
    document.getElementById('hand-slot').innerText = handText;
    
    let clothText = player.clothing.length > 0 ? player.clothing.join(", ") : "Brak";
    document.getElementById('clothing-slot').innerText = clothText;
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

loop();

</script>
</body>
</html>
